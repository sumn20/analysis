<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORSä»£ç†æœåŠ¡å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .proxy-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #fafafa;
        }
        .proxy-name {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 10px;
        }
        .status.testing {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.failed {
            background: #f8d7da;
            color: #721c24;
        }
        .result-details {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .html-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .summary {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ CORSä»£ç†æœåŠ¡å™¨æµ‹è¯•å·¥å…·</h1>
        
        <div class="test-info">
            <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong> https://sj.qq.com/appdetail/tv.danmaku.bili (å“”å“©å“”å“©)
            <br>
            <strong>æµ‹è¯•ç›®çš„ï¼š</strong> æ£€æµ‹å“ªäº›ä»£ç†æœåŠ¡å™¨èƒ½å¤ŸæˆåŠŸè·å–åº”ç”¨å®é¡µé¢å†…å®¹
        </div>

        <div class="controls">
            <button id="startTest" onclick="startTest()">å¼€å§‹æµ‹è¯•æ‰€æœ‰ä»£ç†</button>
            <button id="clearResults" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>

        <div id="results"></div>

        <div id="summary" class="summary" style="display: none;">
            <h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        // CORS ä»£ç†æœåŠ¡åˆ—è¡¨
        const corsProxies = [
            {
                name: 'AllOrigins (æ¨è)',
                url: 'https://api.allorigins.win/get?url=',
                type: 'json'
            },
            {
                name: 'CORS Anywhere (Heroku)',
                url: 'https://cors-anywhere.herokuapp.com/',
                type: 'direct'
            },
            {
                name: 'CodeTabs Proxy',
                url: 'https://api.codetabs.com/v1/proxy?quest=',
                type: 'direct'
            },
            {
                name: 'ThingProxy',
                url: 'https://thingproxy.freeboard.io/fetch/',
                type: 'direct'
            },
            {
                name: 'CORS Bridged',
                url: 'https://cors.bridged.cc/',
                type: 'direct'
            },
            {
                name: 'YACDN Proxy',
                url: 'https://yacdn.org/proxy/',
                type: 'direct'
            },
            {
                name: 'Proxify',
                url: 'https://api.proxify.io?url=',
                type: 'direct'
            },
            {
                name: 'CrossOrigin.me',
                url: 'https://crossorigin.me/',
                type: 'direct'
            },
            {
                name: 'HTML Driven CORS Proxy',
                url: 'https://cors-proxy.htmldriven.com/?url=',
                type: 'direct'
            },
            {
                name: 'CORS.sh',
                url: 'https://proxy.cors.sh/',
                type: 'direct'
            }
        ];

        const targetUrl = 'https://sj.qq.com/appdetail/tv.danmaku.bili';
        let testResults = [];

        function createProxyElement(proxy, index) {
            return `
                <div class="proxy-item" id="proxy-${index}">
                    <div class="proxy-name">${index + 1}. ${proxy.name}</div>
                    <div class="proxy-url" style="font-family: monospace; color: #666; margin-bottom: 10px;">
                        ${proxy.url}
                    </div>
                    <div id="status-${index}" class="status testing">ç­‰å¾…æµ‹è¯•</div>
                    <div id="details-${index}" class="result-details"></div>
                    <div id="preview-${index}" class="html-preview" style="display: none;"></div>
                </div>
            `;
        }

        function initializeResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = corsProxies.map((proxy, index) => 
                createProxyElement(proxy, index)
            ).join('');
        }

        async function testProxy(proxy, index) {
            const statusEl = document.getElementById(`status-${index}`);
            const detailsEl = document.getElementById(`details-${index}`);
            const previewEl = document.getElementById(`preview-${index}`);

            statusEl.className = 'status testing';
            statusEl.textContent = 'æµ‹è¯•ä¸­...';
            detailsEl.textContent = '';
            previewEl.style.display = 'none';

            const startTime = Date.now();

            try {
                let proxyUrl;
                let response;
                let html;

                if (proxy.type === 'json') {
                    // AllOrigins è¿”å› JSON æ ¼å¼
                    proxyUrl = `${proxy.url}${encodeURIComponent(targetUrl)}`;
                    response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (!data.contents) {
                        throw new Error('è¿”å›æ•°æ®ä¸ºç©º');
                    }
                    html = data.contents;
                } else {
                    // å…¶ä»–ä»£ç†ç›´æ¥è¿”å› HTML
                    proxyUrl = `${proxy.url}${targetUrl}`;
                    response = await fetch(proxyUrl, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    html = await response.text();
                }

                const endTime = Date.now();
                const duration = endTime - startTime;

                // æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–åˆ°å†…å®¹
                const hasAppName = html.includes('å“”å“©å“”å“©') || html.includes('bilibili');
                const hasGameCard = html.includes('GameCard') || html.includes('app');
                const isValidHtml = html.includes('<html') || html.includes('<!DOCTYPE');
                const hasMinLength = html.length > 500; // é™ä½æœ€å°é•¿åº¦è¦æ±‚
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯åº”ç”¨å®çš„é”™è¯¯é¡µé¢
                const isErrorPage = html.includes('é¡µé¢ä¸å­˜åœ¨') || html.includes('æ‰¾ä¸åˆ°') || html.includes('404');
                
                // åªè¦èƒ½è·å–åˆ°æœ‰æ•ˆçš„HTMLå†…å®¹å°±ç®—æˆåŠŸï¼ˆå³ä½¿æ˜¯é”™è¯¯é¡µé¢ï¼‰
                const isSuccess = hasMinLength && isValidHtml;

                if (isSuccess) {
                    statusEl.className = 'status success';
                    statusEl.textContent = isErrorPage ? 'âš ï¸ æˆåŠŸ(é”™è¯¯é¡µ)' : (hasAppName ? 'âœ… æˆåŠŸ(å®Œæ•´)' : 'âœ… æˆåŠŸ');
                    detailsEl.innerHTML = `
                        <strong>å“åº”æ—¶é—´:</strong> ${duration}ms<br>
                        <strong>å†…å®¹é•¿åº¦:</strong> ${html.length} å­—ç¬¦<br>
                        <strong>åŒ…å«åº”ç”¨å:</strong> ${hasAppName ? 'æ˜¯' : 'å¦'}<br>
                        <strong>æ˜¯å¦é”™è¯¯é¡µ:</strong> ${isErrorPage ? 'æ˜¯' : 'å¦'}<br>
                        <strong>ä»£ç†URL:</strong> <a href="${proxyUrl}" target="_blank">${proxyUrl}</a>
                        <br><button onclick="togglePreview(${index})" style="margin-top: 5px; padding: 3px 8px; font-size: 12px;">æŸ¥çœ‹HTMLé¢„è§ˆ</button>
                    `;
                    previewEl.textContent = html.substring(0, 2000) + (html.length > 2000 ? '...' : '');
                    
                    testResults.push({
                        index,
                        name: proxy.name,
                        url: proxy.url,
                        success: true,
                        duration,
                        contentLength: html.length,
                        hasAppName,
                        isErrorPage
                    });
                } else {
                    throw new Error(`å†…å®¹éªŒè¯å¤±è´¥ (é•¿åº¦: ${html.length}, æœ‰æ•ˆHTML: ${isValidHtml})`);
                }

            } catch (error) {
                const endTime = Date.now();
                const duration = endTime - startTime;

                statusEl.className = 'status failed';
                statusEl.textContent = 'âŒ å¤±è´¥';
                detailsEl.innerHTML = `
                    <strong>é”™è¯¯:</strong> ${error.message}<br>
                    <strong>è€—æ—¶:</strong> ${duration}ms
                `;

                testResults.push({
                    index,
                    name: proxy.name,
                    url: proxy.url,
                    success: false,
                    duration,
                    error: error.message
                });
            }
        }

        function togglePreview(index) {
            const previewEl = document.getElementById(`preview-${index}`);
            previewEl.style.display = previewEl.style.display === 'none' ? 'block' : 'none';
        }

        async function startTest() {
            const startBtn = document.getElementById('startTest');
            startBtn.disabled = true;
            startBtn.textContent = 'æµ‹è¯•ä¸­...';
            
            testResults = [];
            document.getElementById('summary').style.display = 'none';

            // åˆå§‹åŒ–ç»“æœæ˜¾ç¤º
            initializeResults();

            // å¹¶å‘æµ‹è¯•æ‰€æœ‰ä»£ç†ï¼ˆé™åˆ¶å¹¶å‘æ•°ï¼‰
            const concurrency = 3; // åŒæ—¶æµ‹è¯•3ä¸ªä»£ç†
            for (let i = 0; i < corsProxies.length; i += concurrency) {
                const batch = corsProxies.slice(i, i + concurrency);
                const promises = batch.map((proxy, batchIndex) => 
                    testProxy(proxy, i + batchIndex)
                );
                await Promise.all(promises);
                
                // æ¯æ‰¹ä¹‹é—´ç¨å¾®å»¶è¿Ÿ
                if (i + concurrency < corsProxies.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            // æ˜¾ç¤ºæµ‹è¯•æ€»ç»“
            showSummary();

            startBtn.disabled = false;
            startBtn.textContent = 'é‡æ–°æµ‹è¯•';
        }

        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');
            
            const successfulProxies = testResults.filter(r => r.success);
            const failedProxies = testResults.filter(r => !r.success);
            
            // æŒ‰å“åº”æ—¶é—´æ’åºæˆåŠŸçš„ä»£ç†
            successfulProxies.sort((a, b) => a.duration - b.duration);
            
            let summaryHtml = `
                <p><strong>æ€»è®¡:</strong> ${corsProxies.length} ä¸ªä»£ç†æœåŠ¡å™¨</p>
                <p><strong>æˆåŠŸ:</strong> ${successfulProxies.length} ä¸ª</p>
                <p><strong>å¤±è´¥:</strong> ${failedProxies.length} ä¸ª</p>
            `;
            
            if (successfulProxies.length > 0) {
                summaryHtml += `
                    <h4>ğŸ† æ¨èæ’åº (æŒ‰å“åº”æ—¶é—´):</h4>
                    <ol>
                `;
                successfulProxies.forEach(proxy => {
                    let statusIcon = '';
                    if (proxy.hasAppName) {
                        statusIcon = 'âœ… å®Œæ•´å†…å®¹';
                    } else if (proxy.isErrorPage) {
                        statusIcon = 'âš ï¸ é”™è¯¯é¡µé¢';
                    } else {
                        statusIcon = 'âœ… æœ‰æ•ˆå“åº”';
                    }
                    
                    summaryHtml += `
                        <li>
                            <strong>${proxy.name}</strong> 
                            (${proxy.duration}ms, ${proxy.contentLength} å­—ç¬¦)
                            ${statusIcon}
                        </li>
                    `;
                });
                summaryHtml += '</ol>';
                
                summaryHtml += `
                    <h4>ğŸ“‹ ä»£ç ä¸­çš„æ¨èé¡ºåº:</h4>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto;">const corsProxies = [
${successfulProxies.map(proxy => `    '${proxy.url}',`).join('\n')}
];</pre>
                `;
            }
            
            summaryContent.innerHTML = summaryHtml;
            summaryDiv.style.display = 'block';
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testResults = [];
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initializeResults();
        };
    </script>
</body>
</html>